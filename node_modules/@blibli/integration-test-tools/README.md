# Blibli Integration Test Tools

This library provides you with helpers, predefined configs 
and scripts/snippets that can be utilized across projects.

## [Tech Stack](#tech-stack)

**Framework**: `jest`

**Browser Runner**: `playwright@1.17.1`

**Machine Runner**: `docker` [Playwright Runner](https://hub.docker.com/r/bliblidotcom/playwright-runner)

**Coverage Reporter**: `istanbul` format with `nyc` for report merge

**Snapshot Diff**: `jest-image-snapshot`

**Snapshot Error Populator**: `jest-circus`

**Docker Image Runner**: `docker pull bliblidotcom/playwright-runner:1.17.1`

<br>

## [Set up](#setup)

Integration init will add the required config integration-test-tools to your project.

How to use integration init?

Run:

`npx blibli-integration init`

### List files generated
|File| Do |
|--|--|
| blibli-integration-test.config.js | Create |
| .gitignore | Append |
| .gitattributes | Append |
| package.json | Append |
| Folder /integrations/specs/test-feature | Create |
| Test suites. `dekstop-test.spec.js` & `mobile-test.spec.js` | Create |
| sonar-project.properties.default | Append |
| .babelrc | Append |
| Jenkinsfile | Append |
<br>

## [How To Use](#how-to-use)

You can refer to the confluence page for the collab: 
[How to initiate UI Integration Test - Collab](https://confluence.gdn-app.com/display/GDNIT/How+to+initiate+UI+Integration+Test+-+Collab)

For independent app, you just need to remove/ignore "mainUi" attribute in
the *blibli-integration-test.config.js* , and no need all main related commands (main:prepare, main:run).

For this tools to work, add scripts in package.json:
```json
{
  "scripts": {
    "integration:prepare": "blibli-integration main:prepare",
    "integration:run-main": "blibli-integration main:run",
    "integration:run-docker": "blibli-integration docker:run",
    "integration:stop-docker": "blibli-integration docker:stop",
    "integration:base": "blibli-integration base",
    "integration:updateSnapshot": "blibli-integration updateSnapshot",
    "integration:report": "blibli-integration report",
    "integration:run": "blibli-integration run",
    "integration:run-apps-local": "blibli-integration apps:run-local",
    "integration:run-apps": "blibli-integration apps:run",
    "integration:local": "blibli-integration test:local",
    "integration": "blibli-integration test:ci",
    "test": "npm run unit && npm run integration:prepare && npm run integration"
  }
}
```

This is the standard structure of `blibli-integration-test.config.js`
```js
module.exports = {
  mainUi: {
    repository: 'ssh://git@stash.gdn-app.com:7999/trfeae/pyeongyang-ui-main.git',
    branch: 'feature/integration-test-jest',
    targetDir: 'ui-main',
    waitUrls: ['https-get://localhost:10001'],
    mockPaths: ['integrations/_blibli/ui-main/src/api-mock/index'],
    script: 'dev-nomock-desktop'
  },
  app: {
    script: 'dev-nomock',
    waitUrl: 'http-get://localhost:10027/product-detail/static/js/app.js',
    mockPaths: ['/src/api-mock/index']
  },
  playwright: {
    headless: true, // default to true
    devtools: false,
    debug: false, // debug playwright
    bail: true, // default to true
    inspector: false // default to false
  },
  jest: {
    maxWorkers: '50%'
  },
  unitTest: {
    coverageFinalJsonPaths: ['test/unit/coverage/coverage-final.json']
  },
  // remove this attribute if you do not need to mock
  mock: {
    // you can add array of url(s) here using regex
    urls: [
      // example url that needs to be mocked: /maps.google.com/
    ]
  }
}
```

This is the standard structure of `blibli-integration-test.config.js` for standalone project
```js
module.exports = {
  app: {
    script: 'dev-nomock',
    waitUrls: ['http-get://localhost:8080'],
    mockPaths: ['/src/api/mock/index']
  },
  playwright: {
    headless: true, // default to true
    devtools: false,
    debug: false, // debug playwright
    bail: true, // default to true
    inspector: false // default to false
  },
  jest: {
    testMatch: ['<rootDir>/integrations/specs/**/**.spec.js']
  },
  unitTest: {
    coverageFinalJsonPath: 'test/coverage/coverage-final.json'
  },
  // remove this attribute if you do not need to mock
  mock: {
    // you can add array of url(s) here using regex
    urls: [
      // example url that needs to be mocked: /maps.google.com/
    ]
  }
}
```
### Configuration Detail Information

| Name | Description | Default value |
|----- |-------------|---------------|
| bail | Jest stop running tests after the first failure. Put it in playwright configuration. | ```true``` |
| inspector | Inspect test with chromium window with playwright control button to resume and pause and debug test suites| ```false``` |


This is the standard structure of `Jenkinsfile` for standalone project
```js
@Library('jenkins-ci-automation@feature/move-playwright-image-to-jenkins') _

BlibliPipeline([
  type: 'vue',
  nodejs_version: '14',
  sonar: [
    serverId: 'sonar-gcp'
  ],
  modules: [
    Docker: null
  ],
  test: [
    integration: [
      playwright: [
        enabled: true,
        version: '1.17.1',
        min_cpu: '9' // please set below 15 cpus
      ]
    ]
  ]
])
```

## [Mocking](#mocking)

### [Update/Add mock](#update-add-mock)

You can update/add mock data using global function `$blibli.mock.update`.

```js
$blibli.mock.update(routeObject)
```

`routeObject` is:
```
{
  status, // [int] html response code
  contentType, // default to 'application/json'
  url, // [string] url
  method, // 'GET', 'POST', 'PUT', 'DELETE
  param_values, // values of params as key-value pair
  response, // Object response from mock
  delay, // delay of response in millis
  response_header // Object of response header, if any
}
```
### [Reset updated mock](#reset-update-mock)
```js
$blibli.mock.reset()
```

## [Taking snaphost](#taking-snaphost)
You can use function provided in the libs folder `@blibli/integration-test-tools/lib/utils/snapshot.js`.<br><br>
// deprecated on v1.8.0 or above, replaced by `assertComponentSnapshot`
call `assertSnapshot(expect, page, parameters)` function with parameters of:
* `expect` is the expect function currently used  in the test
* `page` is instance of page to be captured
* `parameters`, object containing other parameters:
    * `screenshot`: options to be used in `page.screenshot` function
    * `options`: options related to screenshot, it will be passed to `jest-image-snapshot` function. The structure is
    the same as parameters for calling `toMatchImageSnapshot`
    * `network`: setting for network wait before doing snapshot
        * default value: 
        ```json
         {
           "timeout": 100,
           "maxInflightRequest": 1
         }  
         ``` 
        * in some cases, you may need to change `maxInflightRequest` to 2 or more, for example
        if you are capturing preloader screen

call `assertComponentSnapshot({expect, page, selector, options: {screenshot, assertConfig, network}})` function with parameters of:
* `expect` is the expect function currently used  in the test
* `page` is instance of page to be captured
* `selector`, string of css selector to element or xpath. can be empty to take full page screenshot
* `screenshot`: options to be used in `page.screenshot` function
* `assertConfig`: options related to screenshot, it will be passed to `jest-image-snapshot` function. The structure is
the same as parameters for calling `toMatchImageSnapshot`
* `network`: setting for network wait before doing snapshot
    * default value: 
    ```json
      {
        "timeout": 100,
        "maxInflightRequest": 1
      }  
      ``` 
    * in some cases, you may need to change `maxInflightRequest` to 2 or more, for example
        if you are capturing preloader screen

## [Utils](#utils)
* <b>[Responsive util](#resonsive-util)</b> 
  ```javascript
  const responsiveUtil = require('@blibli/integration-test-tools/lib/utils/responsive')
  ```
  * `responsiveUtil.sizes`</br>
    const of object as size config to set mobile and desktop width and height with default value
    ```javascript
    const sizes = {
      mobile: {
        width: 360,
        height: 640
      },
      desktop: {
        width: 1280,
        height: 720
      }
    }
    ```
  * `responsiveUtil.setMobile(page, {width, height})`</br>
    Use to set page viewport to mobile
    * <b>Parameters</b>:	
      * page (playwright's class) – page to be resized
      * { width, height } (object) – new width and height in pixels, can be empty, can be change partially e.g. only want to change width or height
  * `responsiveUtil.setDesktop(page, {width, height})`</br>
    Use to set page viewport to desktop
      * <b>Parameters</b>:	
        * page (playwright's class) – page to be resized
        * { width, height } (object) – new width and height in pixels, can be empty, can be change partially e.g. only want to change width or height
* <b>[Network util](#network-util)</b></br>
  Use to wait all network request finishes successfully after downloading the response.
  If the network request timeout > 30ms is found, test will automatically terminated. Please refer to request status table printed in log and provide proper mocking for each request.
  ```javascript
  const networkUtil = require('@blibli/integration-test-tools/lib/utils/network')
  ```
  * `networkUtil.waitForNetworkIdle(page, timeout, maxInflightRequests)`
    * <b>Parameters</b>:	
      * page (playwright's class) – page to be observed
      * timeout (int) – maximum operation time in milliseconds
      * maxInflightRequests (int) - maximum request to be waited, can be empty
* <b>[Snapshot util](#snapshot-util)</b> </br>
  Use to take page snapshot then match it with image baseline
  ```javascript
  const snapshotUtil = require('@blibli/integration-test-tools/lib/utils/snapshot')
  ```
  * `snapshotUtil.assertSnapshot(expect, page,
  { screenshot, options, network })` <br>
  // deprecated on v1.8.0 or above, replaced by  assertComponentSnapshot
    * <b>Parameters</b>:
      * expect (jest's class)
      * page (playwright's class) – page to be observed
      * screenshot (image path) – screenshot image path, can be empty
      * options (object) - toMatchImageSnapshot options, containing { failureThreshold, failureThresholdType }, can be empty
      * network (object) - network idle options, containing: {
    timeout, maxInflightRequest }, can be empty

  * `snapshotUtil.assertComponentSnapshot({expect, page, selector,
  options: { screenshot, assertConfig, network }})`
    * <b>Parameters</b>:
      * expect (jest's class)
      * page (playwright's class) – page to be observed
      * selector (string) - css selector to specific element, if empty it will snapshot full page.
      * screenshot (image path) – screenshot image path, can be empty
      * assertConfig (object) - toMatchImageSnapshot options, containing { failureThreshold, failureThresholdType }, can be empty
      * network (object) - network idle options, containing: {
    timeout, maxInflightRequest }, can be empty
* <b>[Interaction util](#interaction-util)</b>
  ```javascript
  const interactionUtil = require('@blibli/integration-test-tools/lib/utils/interaction')
  ```
  * `interactionUtil.scrollToSelector(page, selector)`
    * <b>Parameters</b>:	
      * page (playwright's class) – page to be observed
      * selector (string) – CSS selector of praticular element
  * `interactionUtil.scrollTo (page, { x, y })`
    * <b>Parameters</b>:	
      * page (playwright's class) – page to be observed
      * x (int) – x axis position in pixels
      * y (int) - y axis position in pixels
* <b>[Host util](#host-util)</b> 
  ```javascript
  const host = require('@blibli/integration-test-tools/lib/utils/host')
  ```
  | API               | Description |
  | ----------------- | ----------- |
  | `host.isDocker`   | will return boolean |
  | `host.name`       | will return string 'localhost' or 'host.docker.internal' based on isDocker value. Used for write url in page.goto, better use host.name instead of harcoded string 'localhost'. |
  | `host.targetHost` | will return the string from `host.name` **with port**. If you don't set the port, it will return only `host.name`. |

  #### How to use
  * **host.name**
    ```javascript
    // Example:
    await page.goto(`https://${host.name}:10001/member/order/digital/completed`)
    ```


  * **host.targetHost**

    You have to add the port key in `blibli-integration-test.config.js`.
    ```javascript
    // Example port is 10001
    // just choose one
    
    // for Collab
    mainUi: {
      ...
      port: '10001'
    },

    // for Standalone
    app: {
      ...
      port: '10001'
    },
    ```

    Next, use `host.targetHost` in the spec file
    ```javascript
    // Example:
    await page.goto(`https://${host.targetHost}/member/order/digital/completed`)
    ```

* <b>[DataLayer Util](#datalayer-util)</b>
  #### How to use: 
  ```javascript
  // import
  const dataLayerUtil = require('@blibli/integration-test-tools/lib/utils/datalayer')
  ...
  // example: 
  await dataLayerUtil.assertDataLayerEvent(expect, page, {
    event: {
      id: String, // id event
      index: Number, // index data from event. This is optional, Default value 0.
      key: String // key is additional event filters. This is optional. Written in dot-notation.
      partialObj: {
        ... // asserts
      }
    }
  })
  ```
  #### Param template
  Short tutorial on making param templates.

  #### **Example 1 with index:** 

  if you have assert. for example like this:
  ```javascript
  // asserts for event 'productImpressionRetail'
  expect(expectedTracker[1].pageType).toEqual('retail-promotion')
  expect(expectedTracker[1].eventDetails.category).toEqual('retail-promotion')
  expect(expectedTracker[1].ecommerce.impressions[0].list).toEqual('Promotion FLASH_SALE/FS NOT Lazy Load UPCOMING')
  ```

  Now, you will create `event` param:
  #### event id
  Put id event in param `event.id`
  ```javascript
  event: {
    id: 'productImpressionRetail',
    ...
  }
  ```

  #### event index
  For the `index` event data used (expectedTracker[1]), you can put it in `event.index`. 
  The default value is 0.
  ```javascript
  event: {
    ...
    index: 1,
    ...
  }
  ```

  #### Additional event filters


  #### event asserts
  You can put it in `partialObj`.
  use the following format:
  ```javascript
  event: {
    partialObj: {
      keyAssert: 'expect-value',
      keyAssert1: 'expect-value1',
      ...
      keyAssertN: 'expect-valueN',
    }
  }
  ```

  `expect-value` is used to expect from assert.
  
  like this:
  ```javascript
  event: {
    ...
    partialObj: {
      pageType: 'retail-promotion', // i.e. pageType
      eventDetails: {
        category: 'retail-promotion' // eventDetails.category
      },
      ecommerce: {
        impressions: [
          {
            list: 'Promotion FLASH_SALE/FS NOT Lazy Load UPCOMING' // ecommerce.impressions[0].list
          }
        ]
      }
    }
  }
  ```

  #### Finally
  Put it in your test
  ```javascript
  // import
  const dataLayerUtil = require('@blibli/integration-test-tools/lib/utils/datalayer')
  ...
  // example: 
  await dataLayerUtil.assertDataLayerEvent(expect, page, {
    event: {
      id: 'productImpressionRetail',
      index: 1, // optional, default value 0.
      partialObj: {
        pageType: 'retail-promotion',
        eventDetails: {
          category: 'retail-promotion'
        },
        ecommerce: {
          impressions: [
            {
              list: 'Promotion FLASH_SALE/FS NOT Lazy Load UPCOMING'
            }
          ]
        }
      }
    }
  })
  ```

  #### **Example 2 with additional filter:** 

  If you have assert with additional Filter. for example like this:
  ```javascript
  const trackers = await page.evaluate(eventId =>
      window.dataLayer.filter(tracker => tracker.event === eventId), 'buttonIconView')

  // Additional Filter using eventDetails.label 
  const expectedTracker = trackers.find(tracker =>
    tracker?.eventDetails?.label === 'pickupLocation£MPP-0000-0000-0015£PP-3068587')
  
  // asserts for event 'buttonIconView'
  expect(expectedTracker).toEqual({
    event: 'buttonIconView',
    pageType: 'retail-product-detail',
    eventDetails: {
      action: 'buttonIconView',
      category: 'retail-product-detail',
      label: 'pickupLocation£MPP-0000-0000-0015£PP-3068587'
    }
  })
  ```

  You can use `key` for additional filter. For example 'eventDetails.label'. You must write it in dot-notation.
  
  datalayerUtil will look like this:
  ```javascript
  // import
  const dataLayerUtil = require('@blibli/integration-test-tools/lib/utils/datalayer')
  ...
  // example: 
  await dataLayerUtil.assertDataLayerEvent(expect, page, {
    event: {
      id: 'buttonIconView',
      key: 'eventDetails.label', // additional filters. This is optional.
      partialObj: {
        pageType: 'retail-product-detail',
        eventDetails: {
          action: 'buttonIconView',
          category: 'retail-product-detail',
          label: 'pickupLocation£MPP-0000-0000-0015£PP-3068587'
        }
      }
    }
  })
  ```

* <b>[Click Util](#click-util)</b>
  #### How to use: 
  ```javascript
  // import
  const clickUtil = require('@blibli/integration-test-tools/lib/utils/click')
  ...
  // example: 
  await clickUtil.clickElement(page, '.css-selector')
  ```
  #### Parameters:

  param: clickUtil.clickElement(page, selector)

  - page (playwright's class) – page to be resized
  - selector (playwright's class) - Selectors are strings that are used to create Locators. [Detail](https://playwright.dev/docs/selectors)

* <b>[Animation Util](#animation-util)</b>
  
  Animation util has function to stop css animation
  #### How to use: 
  ```javascript
  // import
  const animationUtil = require('@blibli/integration-test-tools/lib/utils/animation')
  ...
  // put it within beforeAll
    await animationUtil.stopAnimations(page)
    ```

## Integration Tests Best Practices

The guideline landing page here: [UI Integration Test](https://confluence.gdn-app.com/display/GDNIT/UI+Integration+Test)

Please refer to the cases here:
[UI Integration Test Implementation](https://confluence.gdn-app.com/display/GDNIT/UI+Integration+Test+Implementation)<br><br><br>

# [Changelog](#changelog)
## [1.9.7] - 2023-09-19
* Implement jest.retryTimes with configurable config
* Improvement coverage now proceed if there is error instead of blocking the test
* Set stop CSS animation as default behaviour
## [1.9.6] - 2023-08-30
* Bug fixing docker path from localhost to 127.0.0.1 to support nodejs > 16 projects
## [1.9.5] - 2023-08-29
* Improvement by adding drop API call if mock not found
* Improvement by adding info when test doesn't have coverage
## [1.9.4] - 2023-08-04
* Bug fixing filter requested url to support collab with nothirdparty query params
* Bug fixing stop test when wait-on timeout in Jenkins build
## [1.9.3] - 2023-05-30
### Changes
* Improvement mock header response
* Bug fix double report generate in jenkins build
## [1.9.2] - 2023-05-12
### Changes
* Improvement by adding sanitazion process before merge all coverage to support vue migration to vite
* Improvement to support M2 machine to run playwright runner docker image
## [1.8.1] - 2022-10-06
### Changes
* Bug fixes port info and target host utils 
* Improvement npx blibli-integration init (adding generate Jenkinsfile, .babelrc, sonar-project.properties.default)
* Improvement npm run integration:report automatically open coverage report page
## [1.8.0] - 2022-09-30
### Changes
* Add eslint rules regarding playwright test syntax
* Add script to stop animation in each page
* Make --bail option configurable
* Add new assertComponentSnapshot
* Add new clickUtil
## [1.7.8] - 2022-07-25
### Changes
* Block url access outside localhost (e.g. static-src|uata|uatb) for more consistent snapshot
* Put new error log if network request timeout more than 30ms, spec.js file will be automatically terminated
## [1.7.3] - 2022-07-06
### Changes
* Update playwright version to 1.17.1
* Support arm users
* Add one line command to init integration test
## [1.6.1] - 2022-06-24
### Changes
* Grant permission for clipboard read and write
* Fix generated .eslintrc 'jest/globals' issue
## [1.6.0] - 2022-06-21
### Change
* Create new dataLayerUtil
## [1.5.0] - 2022-06-02
### Change
* Create new feature to generate configuration files
## [1.4.0] - 2022-03-14
### Change
* fix undetected minor diff of image snapshot due to failureThreshold default value
## [1.3.0-3] - 2022-03-04
### Change
* fix mock urls
* fix headers referer undefined
## [1.1.17] - 2021-09-27
### Change
* prevent overriding same API URL with different HTTP method
## [1.1.16] - 2021-09-14
### Change
* add adjusment for integration coverage
## [1.1.14] - 2021-09-01
### Change
* add validation each test must have at least one assertion 
* modify _stringfy function by adding smart-deep-sort
## [1.1.12] - 2021-07-12
### Change
* [interaction-util] fix scrollTo function
* add util list and how to use it
## [1.1.11] - 2021-06-15
### Change
* [mock-loader] ignore loading mock ui-main to support standalone project

## Any question?

Please contact:
* [Resly Suniar](mailto:resly.suniar@gdn-commerce.com)
* [Herwidodo](mailto:herwidodo@gdn-commerce.com)
* [Hidayat Febiansyah](mailto:hidayat.febiansyah@gdn-commerce.com)

Great Heads Up and Thanks to:
- [Deviani](mailto:deviani@gdn-commerce.com)
- [Adhika Setya Pramudika](mailto:adhika.pramudita@gdn-commerce.com)

## Contributors
- [Juan Tjandra](mailto:juan.tjandra@gdn-commerce.com)
- [Karnando Sepryan](mailto:karnando.sepryan@gdn-commerce.com)
- [Muhammad Pazrin Andreanor](mailto:muhammad.andreanor@gdn-commerce.com)
- [Vito Rizki Imanda](mailto:vito.imanda@gdn-commerce.com)
