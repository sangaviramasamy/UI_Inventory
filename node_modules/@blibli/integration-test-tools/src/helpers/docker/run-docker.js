const playwrightConfig = require('./playwright')
const { spawn } = require('../../utils/proc')
const { dockerStop } = require('./stop-docker')
const process = require('process')
const chalk = require('chalk')

const playwrightDocker = 'bliblidotcom/playwright-runner:' + playwrightConfig.dockerImageTag

function _boolToString (b, defaultVal) {
  if (b === undefined) return defaultVal
  return b ? 'true' : 'false'
}

const playwrightParams = {
  PWDEBUG: Number(playwrightConfig.inspector),
  PLAYWRIGHT_HEADLESS: _boolToString(playwrightConfig.headless, true),
  PLAYWRIGHT_DEVTOOLS: _boolToString(playwrightConfig.devtools)
}

if (!playwrightParams.PLAYWRIGHT_HEADLESS) {
  console.log(chalk.red('You are running docker with headless=false mode',
    'Please make sure Xming (windows) or XQuartz (mac) is currently running properly.'))
}

const playwrightParamsArr = Object.entries(playwrightParams)
  .filter(([_, value]) => value)
  .flatMap(([key, value]) => ['-e', `${key}=${value}`])

const procArgs = [
  'run',
  '--rm',
  '--ipc=host',
  '-p',
  '44300:44300',
  '-p',
  '44301:44301',
  '-e',
  'DISPLAY=host.docker.internal:0',
  ...playwrightParamsArr,
  playwrightDocker
]
const cmd = 'docker'

function dockerRun () {
  console.log(chalk.blue('Running Docker'))
  // docker run -it --rm --ipc=host -p 44300:44300 -p 44301:44301 \
  // -e DISPLAY=host.docker.internal:0 -e PLAYWRIGHT_HEADLESS=false \
  // -e PLAYWRIGHT_DEVTOOLS=true bliblidotcom/playwright-runner:1.17.1
  const ps = spawn(cmd, procArgs)

  process.on('exit', dockerStop)
  process.on('SIGINT', dockerStop)
  process.on('SIGTERM', dockerStop)
}

module.exports = {
  dockerRun
}
