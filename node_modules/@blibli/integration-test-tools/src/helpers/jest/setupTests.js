const { toMatchImageSnapshot, configureToMatchImageSnapshot } = require('jest-image-snapshot')
const { playwright: config } = require('../blibli-integration-test.config')

const imageSnapshotConfig = {
  comparisonMethod: 'ssim',
  failureThreshold: 0.01,
  failureThresholdType: 'percent',
  // apply blur to tolerate intermittent inaccuracy on snapshot
  blur: 1
}

configureToMatchImageSnapshot(imageSnapshotConfig)

expect.extend({ toMatchImageSnapshot })

// jest retry test if failed
if (config.setRetry) {
  jest.retryTimes(config.retryTimes, { logErrorsBeforeRetry: true })
}

// setting up mock hooks

global.beforeEach(async () => {
  global.$blibli.mock.loader.startSession()
})

global.afterEach(async () => {
  global.$blibli.mock.loader.endSession()
  global.$blibli.mock.loader.resetSessionMock()
})

global.afterAll(async () => {
  global.$blibli.mock.loader.resetMock()
})
