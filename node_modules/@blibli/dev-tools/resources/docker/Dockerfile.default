FROM asia.gcr.io/nonprod-utility-233414/base-images/nginx_openresty:nginx_openresty-alpine-1.0.4

USER root

RUN mkdir -p /opt/{{ROOT_DIR}}/www{{STATIC_DIR}}/{{APP_VERSION}} 

WORKDIR /opt/{{ROOT_DIR}}/www{{STATIC_DIR}}

COPY target/{{GROUP_ID}}-{{APP_NAME}}/{{APP_VERSION}} /opt/{{ROOT_DIR}}/www{{STATIC_DIR}}/{{APP_VERSION}}

RUN ln -s {{APP_VERSION}} latest

RUN chown -R nginx:nginx /opt/{{ROOT_DIR}}/ \
  && chmod -R 766 /opt/{{ROOT_DIR}}/

USER nginx

EXPOSE 8080

CMD ["/opt/openresty/bin/openresty", "-g", "daemon off;"]
